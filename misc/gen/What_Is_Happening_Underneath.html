<html>
  <head>
    <link rel=stylesheet href=../../theme.css>
    <script src='../../theme-switcher.js'></script>
    <title>
 What Is Happening Underneath
</title></head><body>
    <div class=header>
      <a href="/">Home</a>
      <a href="/lists/gen/All_Songs.html">Songs</a>
      <a href="/lists/gen/All_Speeches.html">Speeches</a>
      <a href="/misc/gen/Programs.html">Programs</a>
    </div>
<h1 id="what-is-happening-underneath">What Is Happening Underneath</h1>
<h2 id="github-pages">Github Pages</h2>
<p>Every file in this git repository is available via http from secularsolstice.github.io. Most of the files people are expected to look at are in the <code>gen</code> directories, but some (such as <code>index.html</code> and <code>theme.css</code> in the root directory) are not. This is a github feature called “Github Pages”.</p>
<p>How <em>that</em> works behind the scenes I don’t know. It does seem to involve copying data on a timer, because there is an intermittent delay between pushing content and that content being visible on the website.</p>
<h2 id="song-pages">Song Pages</h2>
<p>Each song folder has a <code>Makefile</code> which mostly imports <code>scripts/Makefile.common</code>. It sets two variables first, <code>PREFIX</code> which gets prepended to output files and <code>FILES_TO_LIST</code> which makes dependency detection work.</p>
<p>Rules for converting formats live in the common makefile. These include:</p>
<ul>
<li>ly -&gt; pdf</li>
<li>ly -&gt; midi</li>
<li>midi -&gt; wav</li>
<li>wav -&gt; mp3</li>
<li>csv -&gt; html (deprecated)</li>
<li>ugc &gt; cho</li>
<li>cho -&gt; pdf</li>
<li>cho -&gt; pdf with two columns (request this by including <code>chord-sheet-2col.pdf</code> in <code>FILES_TO_LIST</code>)</li>
</ul>
<p>Each song makefile must also provide a rule for <code>gen/${PREFIX}lyrics.txt</code> which contains the lyrics in simple text format. This could be as simple as copying a file, or could use one of the lyric-extractor scripts in the <code>scripts</code> directory. Most of these extractions are reasonably straightforward, but the lilypond one is a bit more complicated. It does not parse the entire lilypond format, but recognizes lyricsmode commands. It expects verses to be in order, and choruses to be named “chorus”.</p>
<p>The common makefile then invokes <code>scripts/create-index.sh</code> to create index.html and <code>scripts/create-thumb.sh</code> to create thumb.png. The latter is shown in the preview if the song is shared on Facebook or Twitter.</p>
<h2 id="speeches-and-activities">Speeches and Activities</h2>
<p>So far as the scripts are concerned, the only difference between a speech and an activity is that one is on the <code>All_Speeches</code> list and the other on the <code>All_Activities</code>. Either way, it’s a simple markdown file.</p>
<h2 id="lists">Lists</h2>
<p>Lists, whether All_* or a program, are processed by <code>scripts/process_list.py</code>. This extracts the title, creator and (for songs) synopsis from the item’s own files. This helps ensure that everything stays in sync.</p>
<p>The script is still in python 2. Hope that doesn’t come around to bite us.</p>
<h2 id="programs-list">Programs List</h2>
<p>The list of programs is generated by <code>scripts/create-program-list.sh</code> invoked from the Makefile in <code>misc</code>. The columns are handled by a crude hack that could use improvement.</p>
<h2 id="documents">Documents</h2>
<p>Additional documents, like this one, live in <code>misc</code> as simple markdown. The table of contents in the How document is manual – it just wasn’t worth wrestling the pandoc <code>--toc</code> flag into submission.</p>
<h2 id="list-builder">List Builder</h2>
<p>The list builder tool is static html and javascript that lives in misc, but its autocomplete data is generated by the misc Makefile (using <code>scripts/gather_lists.sh</code>).</p>
<h2 id="automatic-building">Automatic Building</h2>
<p>When you push, a github action is triggered. Through this, a github server spins up a docker container, pulls the repo, runs make all, adds/commits/pushes the results, and spins down the container. This is all defined in <code>.github/workflows/autogen.yml</code>.</p>
<p>The docker image is defined in <code>.github/workflows/Dockerfile</code>, but github doesn’t look at the Dockerfile directly. Instead it pulls the image from dockerhub.</p>
<p>To view the status on an autobuild, click the “Actions” tab on github, then the push of interest, then the “build” job in the box on the left. Github supports having multiple jobs in one workflow, and the UI is optimized for that case, even though I can’t think of a case where it’s useful.</p>
<h2 id="color-themes">Color Themes</h2>
<p>By default, everything appears light-on-dark, as is appropriate for the longest night of the year. But this caused throuble for some people, especially for copy-pasting into wysiwyg word processors. So there’s now a button to toggle to a dark-on-light color scheme.</p>
<p>The button and its behavior are all in the file <code>theme-switcher.js</code>, which uses raw javascript for its DOM manipulations.</p>
<p>The light theme is implemented by sticking a <code>light</code> css class on the root <code>html</code> element, and letting ancester-based css selectors do the rest of the work.</p>
<p>The user’s chosen theme is stored in a cookie, but can be overridden by appending ?light or ?dark to the url (to allow convenient iframing).</p>
</body></html>
